<!DOCTYPE html>
<html>
<head>
    <title>TapFinity Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin: 0;
            font-family: "Segoe UI", Roboto, sans-serif;
            background: #f4f7fb;
            color: #1f2937;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* ---------- SIDEBAR ---------- */
        .sidebar {
            width: 240px;
            background: #0f4c81;
            color: white;
            padding: 20px;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-item {
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.15);
        }

        /* ---------- MAIN ---------- */
        .main {
            flex: 1;
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        /* ---------- METRICS ---------- */
        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 14px;
            color: #6b7280;
        }

        .card-value {
            font-size: 26px;
            font-weight: 700;
            margin-top: 6px;
        }

        /* ---------- FORMS ---------- */
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            font-size: 15px;
        }

        button {
            padding: 12px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        button.danger {
            background: #dc2626;
        }

        /* ---------- TABLE ---------- */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 14px;
            text-align: left;
        }

        th {
            background: #e5e7eb;
            font-weight: 600;
        }

        tr:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .status-success { color: #059669; }
        .status-failed { color: #dc2626; }

        @media (max-width: 900px) {
            .metrics { grid-template-columns: repeat(2,1fr); }
            .sidebar { display: none; }
        }
    </style>
</head>

<body>

<div class="layout">

    <!-- SIDEBAR -->
    <div class="sidebar">
        <h2>TapFinity</h2>
        <div class="nav-item" onclick="scrollToId('analytics')">Analytics</div>
        <div class="nav-item" onclick="scrollToId('addStudent')">Add Student</div>
        <div class="nav-item" onclick="scrollToId('balance')">Add Balance</div>
        <div class="nav-item" onclick="scrollToId('block')">Block / Unblock</div>
        <div class="nav-item" onclick="scrollToId('transactions')">Transactions</div>
        <div class="nav-item" onclick="logout()">Logout</div>
    </div>

    <!-- MAIN -->
    <div class="main">

        <!-- ANALYTICS -->
        <div id="analytics" class="section">
            <div class="section-title">Analytics</div>
            <div class="metrics">
                <div class="card">
                    <div class="card-title">Total Students</div>
                    <div class="card-value" id="m_students">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Money</div>
                    <div class="card-value" id="m_money">₹0</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Spent</div>
                    <div class="card-value" id="m_spent">₹0</div>
                </div>
                <div class="card">
                    <div class="card-title">Transactions</div>
                    <div class="card-value" id="m_tx">0</div>
                </div>
            </div>
        </div>

        <!-- ADD STUDENT -->
        <div id="addStudent" class="section">
            <div class="section-title">Add Student</div>
            <input id="s_usn" placeholder="USN">
            <input id="s_uid" placeholder="RFID UID">
            <input id="s_name" placeholder="Name">
            <input id="s_phone" placeholder="Phone (WhatsApp)">
            <input id="s_pass" placeholder="Password">
            <input id="s_bal" type="number" placeholder="Initial Balance">
            <button onclick="addStudent()">Add Student</button>
        </div>

        <!-- ADD BALANCE -->
        <div id="balance" class="section">
            <div class="section-title">Add Balance</div>
            <input id="b_usn" placeholder="USN">
            <input id="b_amt" type="number" placeholder="Amount">
            <button onclick="addBalance()">Add Balance</button>
        </div>

        <!-- BLOCK -->
        <div id="block" class="section">
            <div class="section-title">Block / Unblock Card</div>
            <input id="blk_usn" placeholder="USN">
            <button class="danger" onclick="block()">Block</button>
            <button onclick="unblock()">Unblock</button>
        </div>

        <!-- TRANSACTIONS -->
        <div id="transactions" class="section">
            <div class="section-title">Recent Transactions</div>
            <table>
                <thead>
                    <tr>
                        <th>UID</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="tx_table"></tbody>
            </table>
        </div>

    </div>
</div>

<script>
const BASE = "https://tapfinity-backed.onrender.com";

function scrollToId(id) {
    document.getElementById(id).scrollIntoView({ behavior: "smooth" });
}

function logout() {
    window.location.href = "/admin_login";
}

/* ---------------- API CALLS ---------------- */

function addStudent() {
    fetch(BASE + "/api/add_student", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            usn: s_usn.value,
            uid: s_uid.value,
            name: s_name.value,
            phone: s_phone.value,
            password: s_pass.value,
            balance: Number(s_bal.value)
        })
    }).then(()=>location.reload());
}

function addBalance() {
    fetch(BASE + "/api/add_balance", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            usn: b_usn.value,
            amount: Number(b_amt.value)
        })
    }).then(()=>location.reload());
}

function block() {
    fetch(BASE + "/api/block_card", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({usn: blk_usn.value})
    });
}

function unblock() {
    fetch(BASE + "/api/unblock_card", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({usn: blk_usn.value})
    });
}

/* ---------------- LOAD ANALYTICS ---------------- */
fetch(BASE + "/api/admin/analytics")
.then(r=>r.json())
.then(d=>{
    m_students.textContent = d.students;
    m_money.textContent = "₹" + d.total_money;
    m_spent.textContent = "₹" + d.total_spent;
    m_tx.textContent = d.transactions;
});

/* ---------------- LOAD TRANSACTIONS ---------------- */
fetch(BASE + "/api/admin/transactions")
.then(r=>r.json())
.then(rows=>{
    tx_table.innerHTML = rows.map(t=>`
        <tr>
            <td>${t.uid}</td>
            <td>₹${t.amount}</td>
            <td class="${t.status==='success'?'status-success':'status-failed'}">${t.status}</td>
            <td>${t.timestamp}</td>
        </tr>
    `).join("");
});
</script>

</body>
</html>
