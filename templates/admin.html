<!DOCTYPE html>
<html>
<head>
    <title>TapFinity Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin: 0;
            font-family: "Segoe UI", Roboto, sans-serif;
            background: #f4f7fb;
            color: #1f2937;
        }

        .layout { display: flex; min-height: 100vh; }

        /* -------- SIDEBAR -------- */
        .sidebar {
            width: 240px;
            background: #0f4c81;
            color: white;
            padding: 20px;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-item {
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.15);
        }

        /* -------- MAIN -------- */
        .main { flex: 1; padding: 30px; }

        .section { margin-bottom: 40px; }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        /* -------- METRICS -------- */
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .card {
            background: white;
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .card-title { font-size: 14px; color: #6b7280; }
        .card-value { font-size: 28px; font-weight: 700; margin-top: 6px; }

        /* -------- FORMS -------- */
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            font-size: 15px;
        }

        button {
            padding: 12px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        button.danger { background: #dc2626; }

        .feedback {
            margin-top: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .success { color: #059669; }
        .error { color: #dc2626; }

        /* -------- TABLE -------- */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        th, td { padding: 14px; text-align: left; }
        th { background: #e5e7eb; }

        tr:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .status-success { color: #059669; }
        .status-failed { color: #dc2626; }

        @media (max-width: 900px) {
            .metrics { grid-template-columns: repeat(2,1fr); }
            .sidebar { display: none; }
        }
    </style>
</head>

<body>

<div class="layout">

    <!-- SIDEBAR -->
    <div class="sidebar">
        <h2>TapFinity</h2>
        <div class="nav-item" onclick="scrollToId('analytics')">Analytics</div>
        <div class="nav-item" onclick="scrollToId('addStudent')">Add Student</div>
        <div class="nav-item" onclick="scrollToId('balance')">Add Balance</div>
        <div class="nav-item" onclick="scrollToId('block')">Block / Unblock</div>
        <div class="nav-item" onclick="scrollToId('transactions')">Transactions</div>
        <div class="nav-item" onclick="logout()">Logout</div>
    </div>

    <!-- MAIN -->
    <div class="main">

        <!-- ANALYTICS -->
        <div id="analytics" class="section">
            <div class="section-title">Analytics</div>
            <div class="metrics">
                <div class="card">
                    <div class="card-title">Active Students</div>
                    <div class="card-value" id="m_active">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Blocked Students</div>
                    <div class="card-value" id="m_blocked">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Todayâ€™s Transactions</div>
                    <div class="card-value" id="m_today_tx">0</div>
                </div>
            </div>
        </div>

        <!-- ADD STUDENT -->
        <div id="addStudent" class="section">
            <div class="section-title">Add Student</div>
            <input id="s_usn" placeholder="USN">
            <input id="s_uid" placeholder="RFID UID">
            <input id="s_name" placeholder="Name">
            <input id="s_phone" placeholder="Phone">
            <input id="s_pass" placeholder="Password">
            <input id="s_bal" type="number" placeholder="Initial Balance">
            <button onclick="addStudent()">Add Student</button>
            <div id="student_msg" class="feedback"></div>
        </div>

        <!-- ADD BALANCE -->
        <div id="balance" class="section">
            <div class="section-title">Add Balance</div>
            <input id="b_usn" placeholder="USN">
            <input id="b_amt" type="number" placeholder="Amount">
            <button onclick="addBalance()">Add Balance</button>
            <div id="balance_msg" class="feedback"></div>
        </div>

        <!-- BLOCK -->
        <div id="block" class="section">
            <div class="section-title">Block / Unblock Card</div>
            <input id="blk_usn" placeholder="USN">
            <button class="danger" onclick="block()">Block</button>
            <button onclick="unblock()">Unblock</button>
            <div id="block_msg" class="feedback"></div>
        </div>

        <!-- TRANSACTIONS -->
        <div id="transactions" class="section">
            <div class="section-title">Recent Transactions</div>
            <table>
                <thead>
                    <tr>
                        <th>USN</th>
                        <th>Name</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="tx_table"></tbody>
            </table>
        </div>

    </div>
</div>

<script>
const BASE = "https://tapfinity-backed.onrender.com";

function scrollToId(id) {
    document.getElementById(id).scrollIntoView({ behavior: "smooth" });
}

function logout() {
    window.location.href = "/admin_login";
}

/* -------- ADD STUDENT -------- */
function addStudent() {
    fetch(BASE + "/api/add_student", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            usn: s_usn.value,
            uid: s_uid.value,
            name: s_name.value,
            phone: s_phone.value,
            password: s_pass.value,
            balance: Number(s_bal.value)
        })
    }).then(r=>r.json()).then(d=>{
        student_msg.textContent =
            d.status === "success" ? "âœ… Student added successfully" : d.message;
        student_msg.className = "feedback " + (d.status==="success"?"success":"error");
    });
}

/* -------- ADD BALANCE -------- */
function addBalance() {
    fetch(BASE + "/api/add_balance", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ usn:b_usn.value, amount:Number(b_amt.value) })
    }).then(()=>{
        balance_msg.textContent = "âœ… Balance added successfully";
        balance_msg.className = "feedback success";
    });
}

/* -------- BLOCK / UNBLOCK -------- */
function block() {
    fetch(BASE + "/api/block_card", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({usn:blk_usn.value})
    }).then(()=>{
        block_msg.textContent = "ðŸš« Card blocked";
        block_msg.className = "feedback error";
    });
}

function unblock() {
    fetch(BASE + "/api/unblock_card", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({usn:blk_usn.value})
    }).then(()=>{
        block_msg.textContent = "âœ… Card unblocked";
        block_msg.className = "feedback success";
    });
}

/* -------- ANALYTICS -------- */
fetch(BASE + "/api/admin/analytics")
.then(r=>r.json())
.then(d=>{
    m_blocked.textContent = d.blocked_students;
    m_active.textContent = d.total_students - d.blocked_students;
});

/* -------- TRANSACTIONS + TODAY COUNT -------- */
fetch(BASE + "/api/admin/transactions")
.then(r=>r.json())
.then(d=>{
    const today = new Date().toISOString().slice(0,10);
    let todayCount = 0;

    tx_table.innerHTML = d.transactions.map(t=>{
        if (t.timestamp.startsWith(today)) todayCount++;
        return `
            <tr>
                <td>${t.usn}</td>
                <td>${t.name}</td>
                <td>â‚¹${t.amount}</td>
                <td class="${t.status==='success'?'status-success':'status-failed'}">${t.status}</td>
                <td>${t.timestamp}</td>
            </tr>`;
    }).join("");

    m_today_tx.textContent = todayCount;
});
</script>

</body>
</html>
